<!DOCTYPE html>
<html>
<head>
<title>Manometer Beispiel</title>
<style>
canvas {
    border: none;
}
body {
    display: flex;
    flex-direction: column;
    justify-content: center;
}
#menue {
    display: flex;
    justify-content: center;
    gap: 30px;
}
#anzeige {
    position: relative;
    top: -140px;
    border-top: 1px black solid;
    padding-top: 10px;
    width: 400px;
    margin: 0 auto;
}
#anzeige::before {
    content: 'RESTDRUCK: ';
}
#timerDisplay {
    position: relative;
    top: -120px;
    margin: 0 auto;
    width: 400px;
}
#startpress {
    position: relative;
    top: -100px;
    border-top: 1px solid lightgrey;
    width: 400px;
    margin: 0 auto;
    padding-top: 10px;
}
#startpress input {
    width: 200px;
    margin: 20px;
}
#p_rate {
    position: relative;
    top: -90px;
    margin: 0 auto;
}
#p_rate input {
    width: 200px;
    margin: 20px;
}
#startbutton {
    width: 25%;
    margin: 15px;
    padding: 30px;
    top: -80px;
    position: relative;
}
#buttonPause {
    width: 25%;
    margin: 15px;
    padding: 30px;
    top: -80px;
    position: relative;
}
#resetbutton {
    width: 25%;
    margin: 15px;
    padding: 30px;
    top: -80px;
    position: relative;
}
#menue {
    margin: 20px;
}
#timerSettings {
    display: none; /* Standardmäßig ausgeblendet */
}
#timerDiv {
    display: initial;
    position: relative;
    top: -100px;
    margin: 0 auto;
    display: none;
    gap: 10px;
    border-top: 1px solid black;
    width: 400px;
    justify-content: center;
    padding: 5px;
}
#timerDiv label {
    margin: auto;
    margin-left: 0px;
}
#buttonDiv {
    display: flex;
    justify-content: center;
}
#minutesField {
    height: 50px;
}
	#secondsField{
		    display: inline;
    height: 50px;
	}
</style>
<meta charset="utf-8">
</head>
<body onload="init()">
<div id="menue">
  <select id="functionSelect" onchange="toggleFunction()">
    <option value="current">Barometer Funktion</option>
    <option value="timer">Timer Funktion</option>
  </select>
</div>
<canvas id="manometer" width="400" height="400"></canvas>
<div id="anzeige"></div>
<div id="timerDisplay">Verstrichene Zeit: 00:00</div>
<div id="timerDiv">
  <label>Timer (Min:Sec):</label>
</div>
<script>

        var canvas = document.getElementById('manometer');
		var context = canvas.getContext('2d');
        var x = canvas.width / 2;
        var y = canvas.height / 2;
        var radius = canvas.width / 2 - 10;
        var minBar = 0;
        var maxBar = 300;
        var rotBereich = 50;
        var timerId = null;
        var elapsedTime = 0;
        var intervalId = null;
        var paused = false;
        var currentPressure; 
		var countdownInterval; // Variable zum Speichern des Intervalls für den Countdown<br>
		var remainingTime; // Variable zum Speichern der verbleibenden Zeit

        function drawManometer() {
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.beginPath();
            context.arc(x, y, radius + 10, Math.PI, 0, false);
            context.lineWidth = 2;
            context.strokeStyle = '#000000';
            context.stroke();
            context.font = "20px Arial";
            context.textAlign = "center";
            context.textBaseline = "middle";
            for (var i = 0; i <= 6; i++) {
                var grad = i * 50;
                var angle = (((grad / (maxBar - minBar)) * (Math.PI)) - (Math.PI));
                var xGrad = x + Math.cos(angle) * (radius - 20);
                var yGrad = y + Math.sin(angle) * (radius - 20);
                context.fillText(grad.toString(), xGrad, yGrad);
            }
            context.beginPath();
            context.arc(x, y, radius + 5, Math.PI, 0, false);
            context.lineWidth = 5;
            context.strokeStyle = '#000000';
            context.stroke();
            context.beginPath();
            context.arc(x, y, radius - 3, (((50 - rotBereich) / (maxBar - minBar)) * (Math.PI)) + Math.PI, ((50 / (maxBar - minBar)) * (Math.PI)) + Math.PI, false);
            context.lineWidth = 10;
            context.strokeStyle = '#FF0000';
            context.stroke();
        }

        var startDruckSlider = document.createElement("input");
        startDruckSlider.setAttribute("type", "range");
        startDruckSlider.setAttribute("min", minBar);
        startDruckSlider.setAttribute("max", maxBar);
        startDruckSlider.setAttribute("value", maxBar);
        startDruckSlider.setAttribute("step", "10");
        startDruckSlider.setAttribute("style", "width: 200px;");
        startDruckSlider.oninput = function () {
            startDruck = parseInt(this.value);
            drawZeiger(startDruck);
        };

        var startDruckText = document.createTextNode("Startdruck (bar): ");
        var startDruckDiv = document.createElement("div");
        startDruckDiv.setAttribute("id", "startpress");
        startDruckDiv.appendChild(startDruckText);
        startDruckDiv.appendChild(startDruckSlider);
        document.body.appendChild(startDruckDiv);

        var druckAbfallSlider = document.createElement("input");
        druckAbfallSlider.setAttribute("type", "range");
        druckAbfallSlider.setAttribute("min", "1");
        druckAbfallSlider.setAttribute("max", "10");
        druckAbfallSlider.setAttribute("value", "1");
        druckAbfallSlider.setAttribute("step", "1");
        druckAbfallSlider.setAttribute("style", "width: 200px;");
        druckAbfallSlider.oninput = function () {
            druckAbfallRate = parseInt(this.value);
        };

        var druckAbfallText = document.createTextNode("Druckabfall-Rate (bar/s): ");
        var druckAbfallDiv = document.createElement("div");
        druckAbfallDiv.setAttribute("id", "p_rate");
        druckAbfallDiv.appendChild(druckAbfallText);
        druckAbfallDiv.appendChild(druckAbfallSlider);
        document.body.appendChild(druckAbfallDiv);    

        var startButton = document.createElement("button");
		startButton.innerHTML = "Start";
		startButton.setAttribute("id", "startbutton");
		startButton.addEventListener("click", handleStartButtonClickBarometer); // Initialen Event-Listener hinzufügen
		document.body.appendChild(startButton);

        // Pausenbutton erstellen (standardmäßig ausgeblendet)
		var pauseButton = document.createElement("button");
		pauseButton.innerHTML = "Pause";
		pauseButton.setAttribute("id", "buttonPause");
		pauseButton.style.display = "none"; // Standardmäßig ausgeblendet
		pauseButton.addEventListener("click", handlePauseButtonClick); // Event-Listener hinzufügen
		document.body.appendChild(pauseButton);

        // Reset-Button erstellen
		var resetButton = document.createElement("button");
		resetButton.setAttribute("id", "resetbutton");
		resetButton.innerHTML = "Reset";
		resetButton.addEventListener("click", resetManometer); // Event-Listener hinzufügen
		document.body.appendChild(resetButton);

		
		// Ein neues Div-Element für die Buttons erstellen
		var buttonDiv = document.createElement("div");

		// ID für das Div festlegen (optional, aber empfohlen)
		buttonDiv.setAttribute("id", "buttonDiv");

		
		// Die erstellten Buttons zum Div hinzufügen
		buttonDiv.appendChild(startButton);
		buttonDiv.appendChild(pauseButton);
		buttonDiv.appendChild(resetButton);

		// Das Div am Ende des body-Elements platzieren
		document.body.appendChild(buttonDiv);
		
        var fps = 60;
        var startDruck = 300; // Startdruck standardmäßig auf 300 setzen
        var druckAbfallRate = 1;
        var bar = startDruck;

        function drawZeiger(bar) {
            var angle = (((bar - minBar) / (maxBar - minBar)) * (Math.PI)) + Math.PI;
            var xZeiger = x + Math.cos(angle) * (radius - 70);
            var yZeiger = y + Math.sin(angle) * (radius - 70);
            context.beginPath();
            context.arc(x, y, radius - 65, 0, 2 * Math.PI);
            context.fillStyle = '#FFFFFF';
            context.fill();
            context.beginPath();
            context.moveTo(x, y);
            context.lineTo(xZeiger, yZeiger);
            context.lineWidth = 5;
            context.strokeStyle = '#FF0000';
            context.stroke();
            var anzeige = document.getElementById("anzeige");
            anzeige.innerHTML = bar.toFixed(2);
        }

        function updateElapsedTime() {
            var timeDisplay = document.getElementById("timerDisplay");
            var minutes = Math.floor(elapsedTime / 60);
            var seconds = elapsedTime % 60;
            timeDisplay.innerHTML = "Verstrichene Zeit: " + (minutes < 10 ? "0" : "") + minutes + ":" + (seconds < 10 ? "0" : "") + seconds;
        }

        function init() {
            drawManometer();
            drawZeiger(startDruck); // Den Zeiger beim Initialisieren auf den Startdruck setzen
        }

        function openSettingsPopup() {
            // Erstellen des Popup-Containers
            var popupContainer = document.createElement("div");
            popupContainer.setAttribute("id", "settingsPopup");
            popupContainer.style.position = "fixed";
            popupContainer.style.top = "50%";
            popupContainer.style.left = "50%";
            popupContainer.style.transform = "translate(-50%, -50%)";
            popupContainer.style.background = "#fff";
            popupContainer.style.padding = "20px";
            popupContainer.style.border = "2px solid #000";
            popupContainer.style.zIndex = "9999";
            popupContainer.style.height = "150px";

            // Erstellen des Textfelds
            var textField = document.createElement("input");
            textField.setAttribute("type", "text");
            textField.setAttribute("id", "settingsTextField");
            textField.style.marginBottom = "10px";

            // Erstelle ein Label für das Textfeld
            var label = document.createElement("label");
            label.setAttribute("for", "settingsTextField");
            label.textContent = "SSID: ";

            // Füge das Label und das Textfeld dem Popup-Container hinzu
            popupContainer.appendChild(label);
            popupContainer.appendChild(textField);
            
            // Hinweis für WLAN-Verbindung
            var hint = document.createElement("p");
            hint.textContent = "Hinweis: Nach dem Ändern der SSID muss das WLAN neu verbunden werden.";
            hint.style.marginTop = "5px";
            popupContainer.appendChild(hint);

            // Erstellen des Speichern-Buttons
            var saveButton = document.createElement("button");
            saveButton.innerHTML = "Speichern";
            saveButton.addEventListener("click", function() {
                var userInput = document.getElementById("settingsTextField").value;
                // Hier können Sie den Benutzereingang verarbeiten, z. B. speichern oder an einen Server senden
                console.log("Benutzereingabe:", userInput);
                closeSettingsPopup(); // Schließen Sie das Popup nach dem Speichern
            });

            // Hinzufügen des Speichern-Buttons zum Popup-Container
            popupContainer.appendChild(saveButton);

            // Hinzufügen des Popup-Containers zur Seite
            document.body.appendChild(popupContainer);
        }

        // Funktion zum Schließen des Popups
        function closeSettingsPopup() {
            var popup = document.getElementById("settingsPopup");
            if (popup) {
                popup.parentNode.removeChild(popup);
            }
        }

        // Erstellen des Einstellungen-Buttons
        var settingsButton = document.createElement("button");
        settingsButton.innerHTML = "Einstellungen";
        settingsButton.addEventListener("click", openSettingsPopup);

        // Hinzufügen des Einstellungen-Buttons zur Menü-Div
        var menuDiv = document.getElementById("menue");
        menuDiv.appendChild(settingsButton);
				
		var timerDiv = document.createElement("div");
		timerDiv.setAttribute("id", "timerDiv");
		//timerDiv.appendChild(timerText);
		//timerDiv.appendChild(timerField);
		timerDiv.style.display = "none"; // standardmäßig ausblenden
		document.body.appendChild(timerDiv);

function startCountdown() {
    console.log("startCountdown() wird aufgerufen."); // Konsolenausgabe hinzufügen

    // Minuten und Sekunden aus den Eingabefeldern lesen
    var minutes = parseInt(document.getElementById("minutesField").value);
    var seconds = parseInt(document.getElementById("secondsField").value);

    // Insgesamt verbleibende Sekunden berechnen
    var totalSeconds = minutes * 60 + seconds;

    // Startwert für die Bar
    var startBar = 300;

    // Schritte für die Bar berechnen
    var steps = startBar / totalSeconds;

    // Aktualisierungsfrequenz in Millisekunden
    var updateInterval = 1000;

    // Anfangszeit für den Countdown setzen
    var currentTime = totalSeconds;

    // Zeiger initialisieren
    var currentBarValue = startBar;

    // Startwert für die Anzeige
    document.getElementById("timerDisplay").innerHTML = "Verbleibende Zeit: " + formatTime(currentTime);
    document.getElementById("anzeige").innerHTML = "Bar: " + Math.round(currentBarValue);

    // Wenn bereits ein Countdown läuft, nicht erneut starten
    if (!countdownInterval) {
        // Countdown starten
        countdownInterval = setInterval(function() {
            // Wenn nicht pausiert, den Countdown aktualisieren
            if (!paused) {
                // Zeit aktualisieren
                currentTime--;

                // Bar aktualisieren
                currentBarValue -= steps;

                // Anzeige aktualisieren
                document.getElementById("timerDisplay").innerHTML = "Verbleibende Zeit: " + formatTime(currentTime);
                document.getElementById("anzeige").innerHTML = "Bar: " + Math.round(currentBarValue);

                // Zeiger aktualisieren
                drawZeiger(currentBarValue);

                // Wenn die Zeit abgelaufen ist, den Countdown stoppen
                if (currentTime <= 0) {
                    clearInterval(countdownInterval);
                    document.getElementById("timerDisplay").innerHTML = "Verstrichene Zeit: " + formatTime(0);
                    document.getElementById("anzeige").innerHTML = "Bar: 0";
                    drawZeiger(0);
                }
            }
        }, updateInterval);
    }
}

function formatTime(seconds) {
    var minutes = Math.floor(seconds / 60);
    var remainingSeconds = seconds % 60;
    return pad(minutes) + ":" + pad(remainingSeconds);
}

function pad(val) {
    return val < 10 ? "0" + val : val;
}
	
	// Funktion zum Pausieren des Countdowns
function pauseCountdown() {
    paused = true;
}

// Funktion zum Fortsetzen des Countdowns
function resumeCountdown() {
    paused = false;
}

function handlePauseButtonClick() {
	console.log("handlePauseButtonClick")
    var pauseButton = document.getElementById("buttonPause");
    clearInterval(intervalId); // Stoppen des Countdowns bzw. der Barometerfunktion

    if (pauseButton.innerHTML === "Pause") {
        pauseButton.innerHTML = "Fortsetzen";
        // Speichern des aktuellen Druckwerts
        currentPressure = bar;
    } else {
        pauseButton.innerHTML = "Pause";
        // Fortsetzen der Barometerfunktion mit dem gespeicherten Druckwert
        intervalId = setInterval(function () {
            if (!paused) {
                elapsedTime++;
                bar -= druckAbfallRate / fps;
                if (bar < minBar) {
                    bar = minBar;
                    clearInterval(intervalId);
                }
                drawZeiger(bar);
                updateElapsedTime();
            }
        }, 1000 / fps);
    }
}


// Funktion zur Aktualisierung der Anzeige und der Bar basierend auf der verbleibenden Zeit
function updateDisplayAndBar(seconds, startBar) {
    // Anzeige aktualisieren
    document.getElementById("timerDisplay").innerHTML = "Verbleibende Zeit: " + formatTime(seconds);

    // Bar aktualisieren
    var bar = startBar * (seconds / (parseInt(document.getElementById("minutesField").value) * 60));
    drawZeiger(bar);
    document.getElementById("anzeige").innerHTML = "Bar: " + Math.round(bar);
}



// Funktion zur Formatierung der Zeit (Minuten und Sekunden)
function formatTime(seconds) {
    var minutes = Math.floor(seconds / 60);
    var remainingSeconds = seconds % 60;
    return pad(minutes) + ":" + pad(remainingSeconds);
}

// Funktion zur Voranstellung von führenden Nullen
function pad(val) {
    var valString = val + "";
    if (valString.length < 2) {
        return "0" + valString;
    } else {
        return valString;
    }
}

function resetTimer() {
    var minutes = parseInt(document.getElementById("minutesField").value);
    var seconds = parseInt(document.getElementById("secondsField").value);
    remainingTime = minutes * 60 + seconds;

    stopCountdown();
    clearInterval(intervalId);

    var pauseButton = document.getElementById("buttonPause");
    var startButton = document.getElementById("startbutton");

    pauseButton.style.display = "none";
    startButton.style.display = "block";
    pauseButton.innerHTML = "Pause";

    startButton.removeEventListener("click", handleStartButtonClickTimer);
    startButton.addEventListener("click", handleStartButtonClickTimer);

    clearInterval(countdownInterval);
    countdownInterval = null;

    // Reset für den Zeiger
    drawZeiger(300);
}


function resetManometer() {
    // Zurücksetzen der Anzeige auf den Startwert
    var timerDisplay = document.getElementById("timerDisplay");
    timerDisplay.innerHTML = "Verstrichene Zeit: 00:00";

    // Zurücksetzen der Anzeige für das Manometer auf den Startwert
    var anzeige = document.getElementById("anzeige");
    anzeige.innerHTML = startDruck;

    // Zurücksetzen des internen Bar-Werts auf den Startwert
    bar = startDruck;
    
    // Zeiger auf den Startdruck setzen
    drawZeiger(startDruck);

    // Wenn der Countdown läuft, stoppe ihn
    stopCountdown();

    // Setzen des Pause-Buttons zurück und Ausblenden
    var pauseButton = document.getElementById("buttonPause");
    pauseButton.innerHTML = "Pause";
    pauseButton.style.display = "none";

    // Anzeigen des Start-Buttons
    var startButton = document.getElementById("startbutton");
    startButton.style.display = "block";
}
	
// Funktion für den Start-Button in der Timer-Option
function handleStartButtonClickTimer() {
    // Logik für den Start-Button in der Timer-Option
    startCountdown(); // Beispiel: startCountdown();

    // Ändern des Start-Buttons zu einem Pause-Button
    var startButton = document.getElementById("startbutton");
    startButton.style.display = "none"; // Start-Button ausblenden

    var pauseButton = document.getElementById("buttonPause");
    pauseButton.style.display = "block"; // Pause-Button anzeigen
    pauseButton.innerHTML = "Pause"; // Zurücksetzen des Texts auf "Pause"

    // Event-Listener für den Pause-Button hinzufügen
    pauseButton.removeEventListener("click", handlePauseButtonTimer);
    pauseButton.addEventListener("click", handlePauseButtonTimer);
}

// Funktion für den Start-Button in der Timer-Option
function handleStartButtonClickBarometer() {
    console.log("Start Barometer");

    // Zuerst das Manometer zurücksetzen
    resetManometer();

    // Startwert für den Druck
    var startDruck = parseFloat(startDruckSlider.value);

    // Druckabfallrate
    var druckAbfallRate = parseFloat(druckAbfallSlider.value);

    // Zurücksetzen der verstrichenen Zeit
    elapsedTime = 0;

    // Starten der Barometer-Funktion
    intervalId = setInterval(function () {
        if (!paused) {
            elapsedTime++;
            bar -= druckAbfallRate / fps;
            if (bar < minBar) {
                bar = minBar;
                clearInterval(intervalId);
            }
            drawZeiger(bar);
            updateElapsedTime();
        }
    }, 1000 / fps);

    // Ändern des Start-Buttons zu einem Pause-Button
    var startButton = document.getElementById("startbutton");
    startButton.style.display = "none"; // Start-Button ausblenden

    var pauseButton = document.getElementById("buttonPause");
    pauseButton.style.display = "block"; // Pause-Button anzeigen

    // Den Pause-Button auf "Pause" zurücksetzen
    pauseButton.innerHTML = "Pause";

    // Event-Listener für den Pause-Button aktualisieren
    pauseButton.removeEventListener("click", handlePauseButtonClick);
    pauseButton.addEventListener("click", handlePauseButtonClick);
}




	function stopCountdown() {
    clearInterval(intervalId); // Intervalldetektor löschen, um den Countdown zu stoppen
    var timerDisplay = document.getElementById("timerDisplay");
    timerDisplay.innerHTML = "Verbleibende Zeit: 00:00"; // Anzeige auf Null setzen
}
	
// Funktion für den Pause-Button in der Timer-Option
function handlePauseButtonTimer() {
    // Logik für den Pause-Button in der Timer-Option
    var pauseButton = document.getElementById("buttonPause");

    if (pauseButton.innerHTML === "Pause") {
        // Pausieren des Timers
        pauseCountdown(); // Timer pausieren
        pauseButton.innerHTML = "Fortsetzen";
    } else {
        // Fortsetzen des Timers
        resumeCountdown(); // Timer fortsetzen
        pauseButton.innerHTML = "Pause";
    }
}
	
	// Funktion, um die verbleibende Zeit zu berechnen
function calculateRemainingTime() {
    // Minuten und Sekunden aus den Eingabefeldern lesen
    var minutes = parseInt(document.getElementById("minutesField").value);
    var seconds = parseInt(document.getElementById("secondsField").value);

    // Insgesamt verbleibende Sekunden berechnen
    return minutes * 60 + seconds;
}


	// Funktion, um den Timer von der aktuellen verbleibenden Zeit aus zu starten
// Funktion, um den Timer von der aktuellen verbleibenden Zeit aus zu starten
function startCountdownFromCurrentTime() {
    startCountdown(remainingTime);
}
	
function toggleFunction() {
    var functionSelect = document.getElementById("functionSelect"),
        selectedValue = functionSelect.options[functionSelect.selectedIndex].value,
        timerDiv = document.getElementById("timerDiv"),
        minutesField = document.getElementById("minutesField"),
        secondsField = document.getElementById("secondsField"),
        startButton = document.getElementById("startbutton"),
        resetButton = document.getElementById("resetbutton"),
        pauseButton = document.getElementById("buttonPause");

    if (selectedValue === "timer") {
        // Anzeige der Timer-Felder
        if (!minutesField) {
            minutesField = document.createElement("input");
            minutesField.setAttribute("type", "number");
            minutesField.setAttribute("id", "minutesField");
            minutesField.setAttribute("placeholder", "Min");
            minutesField.setAttribute("min", "0");
            minutesField.setAttribute("max", "59");
            minutesField.setAttribute("value", "5");
            minutesField.style.display = "inline";
            timerDiv.appendChild(minutesField);
        }

        if (!secondsField) {
            secondsField = document.createElement("input");
            secondsField.setAttribute("type", "number");
            secondsField.setAttribute("id", "secondsField");
            secondsField.setAttribute("placeholder", "Sec");
            secondsField.setAttribute("min", "0");
            secondsField.setAttribute("max", "59");
            secondsField.setAttribute("value", "0");
            secondsField.style.display = "inline";
            timerDiv.appendChild(secondsField);
        }

        clearInterval(intervalId);
        timerDiv.style.display = "flex";
        document.getElementById("p_rate").style.display = "none";
        document.getElementById("startpress").style.display = "none";
        startButton.removeEventListener("click", handleStartButtonClickBarometer);
        startButton.addEventListener("click", handleStartButtonClickTimer);
        resetButton.removeEventListener("click", resetManometer);
        resetButton.addEventListener("click", resetTimer); // Hier wird resetTimer zugeordnet
        pauseButton.removeEventListener("click", handlePauseButtonClick);
        pauseButton.addEventListener("click", handlePauseButtonTimer);
    } else {
        // Anzeige der Barometer-Felder
        timerDiv.style.display = "none";
        document.getElementById("p_rate").style.display = "block";
        document.getElementById("startpress").style.display = "block";
        stopCountdown();
        startButton.removeEventListener("click", handleStartButtonClickTimer);
        startButton.addEventListener("click", handleStartButtonClickBarometer);
        resetButton.removeEventListener("click", resetTimer); // Hier wird resetTimer entfernt
        resetButton.addEventListener("click", resetManometer);
        pauseButton.removeEventListener("click", handlePauseButtonTimer);
        pauseButton.addEventListener("click", handlePauseButtonClick);
    }
    startButton.style.display = "block";
}


		
</script>
</body>
</html>
